!function(R,y){"use strict";var a=R.ht,O=a.Default,R=O.def,n=O.getInternal();a.HistoryManager=function(R){this._histories=[],this.setDataModel(R)},R(a.HistoryManager,y,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,material:!0,animationStart:!0,animationStop:!0,animationPause:!0,animationResume:!0,animationIteration:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){var R,y;this._disabled||(y=(R=this)._betweenTransaction++,1===R._betweenTransaction&&(R._transactionHistories={}),R.fp("betweenTransaction",y,R._betweenTransaction))},endTransaction:function(){if(!this._disabled&&0!==this._betweenTransaction){var R,y=this;if(1===y._betweenTransaction){if(y._transactionHistories){var Z,D=[];for(Z in y._transactionHistories){var J=y._transactionHistories[Z];O.isArray(J)||(J=[J]),D.push.apply(D,J)}D.length&&(y.addActions(D),y.setHistoryIndex(y._histories.length-1,!0))}delete y._transactionHistories}0<y._betweenTransaction&&(R=y._betweenTransaction--,y.fp("betweenTransaction",R,y._betweenTransaction))}},setDataModel:function(R){var y=this,Z=y._dataModel;Z!==R&&(Z&&(delete Z._historyManager,Z.ump(y.handleDataModelPropertyChange,y),Z.umm(y.$5p,y),Z.umd(y.$6p,y),Z.removeHierarchyChangeListener(y.handleHierarchyChange,y),Z.removeIndexChangeListener(y.handleIndexChange,y)),(y._dataModel=R)&&(R._historyManager=y,R.mp(y.handleDataModelPropertyChange,y),R.mm(y.$5p,y),R.md(y.$6p,y),R.addHierarchyChangeListener(y.handleHierarchyChange,y),R.addIndexChangeListener(y.handleIndexChange,y)),y.fp("dataModel",Z,R),y.clear())},setHistoryIndex:function(R,y){var Z=this,D=Z._historyIndex,J=Z._histories.length;R<-1?R=-1:J<=R&&(R=J-1),D!==R&&(y||(0<(J=R-D)?Z.$2p(J):J<0&&Z.$1p(-J)),Z._historyIndex=R,Z.fp("historyIndex",D,R),Z.dataModel&&Z.dataModel.onHistoryManagerChanged())},setMaxHistoryCount:function(R){var y=this,Z=y._histories,D=y._maxHistoryCount;D!==(R=!R||R<=0?10:R)&&(y._maxHistoryCount=R,y.fp("maxHistoryCount",D,R),Z.length>R&&y.clear())},cloneValue:function(R,y,Z){return a.Default.clone(R)},isPropertyUndoable:function(R,y){return R&&!this.ignoredPropertyMap[R]},isIndexUndoable:function(R){return!1},isDataModelPropertyUndoable:function(R,y){return R&&!this.ignoreDataModelPropertyMap[R]},$5p:function(R){this.handleChange(R,R.kind)},$6p:function(R){this.handleChange(R,"property")},handleHierarchyChange:function(R){this.handleChange(R,"hierarchy")},handleIndexChange:function(R){this.handleChange(R,"index")},handleDataModelPropertyChange:function(R){this.handleChange(R,"dataModelProperty")},toChildrenInfo:function(R){var y={};return y.data=R,y.children=[],R.eachChild(function(R){y.children.push(this.toChildrenInfo(R))},this),y},restoreChildren:function(R){var Z=R.data;R.children.forEach(function(R){var y=R.data;y.getParent()!==Z&&Z.addChild(y),this._dataModel.contains(y)||this._dataModel.add(y),this.restoreChildren(R)},this)},handleChange:function(R,y){var Z,D,J,E,I=this;I._disabled||I._isUndoRedoing||O.loadingRefGraph||(I._histories,Z=R.data,D=R.property,Z&&(Z._refGraph||Z instanceof a.RefGraph)||("property"===y?I.isPropertyUndoable(D,Z)&&(E={kind:y,data:Z,property:D,oldValue:I.cloneValue(R.oldValue,Z,D),newValue:I.cloneValue(R.newValue,Z,D),event:R}):"hierarchy"===y||"index"===y&&I.isIndexUndoable(R)?E={kind:y,data:Z,oldIndex:R.oldIndex,newIndex:R.newIndex,event:R}:"clear"===y?E={kind:y,json:R.json,event:R}:"add"===y?((E={kind:y,data:Z,event:R,childrenInfo:this.toChildrenInfo(Z),parent:Z.getParent()}).parent&&(J=I._dataModel.getSiblings(Z),E.siblingsIndex=J.indexOf(Z)),Z instanceof a.Node&&(E.host=Z.getHost(),E.attaches=Z.getAttaches()?Z.getAttaches().toArray():void 0),Z instanceof a.Edge&&(E.source=Z.getSource(),E.target=Z.getTarget())):"remove"===y?E={kind:y,data:Z,event:R}:"dataModelProperty"===y&&I.isDataModelPropertyUndoable(D,Z)&&(E={kind:y,property:D,oldValue:I.cloneValue(R.oldValue,Z,D),newValue:I.cloneValue(R.newValue,Z,D),event:R}),I.addHistory(E)))},addHistory:function(R){var y,Z,D=this;R&&(D._betweenTransaction?(y=(R.data?R.data._id:0)+"_"+R.kind+"_"+R.property,"property"===R.kind||"dataModelProperty"===R.kind?((Z=D._transactionHistories[y])&&(R.oldValue=Z.oldValue),D._transactionHistories[y]=R):(Z=D._transactionHistories[y])?(Z=O.isArray(Z)?Z:D._transactionHistories[y]=[Z]).push(R):D._transactionHistories[y]=R):(D.addActions([R]),D.setHistoryIndex(D._histories.length-1,!0)))},addActions:function(R){var y=this,Z=y._histories;(Z=Z.slice(0,y._historyIndex+1)).push(R),Z.length>y._maxHistoryCount&&(Z=Z.slice(Z.length-y._maxHistoryCount)),y.setHistories(Z)},canUndo:function(){return!this._disabled&&0<=this._historyIndex&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&-1<=this._historyIndex&&this._historyIndex<this._histories.length-1},undo:function(R){this.setHistoryIndex(this._historyIndex-(R=!R||R<=0?1:R))},$1p:function(R){if(this.canUndo()){var y,Z=this,D=Z._histories,J=Z._historyIndex,E=0;for(Z._isUndoRedoing=!0,O.setIsolating(!0);0<R;)0<=J&&J<D.length&&(E++,y=D[J],J--,Z.undoImpl(y)),R--;O.setIsolating(!1),delete Z._isUndoRedoing,Z.afterUndo(E)}},undoImpl:function(R){for(var y=this._dataModel,Z=R.length-1;0<=Z;Z--){var D,J=R[Z],E=J.kind,I=J.data,W=J.property,c=J.event,H=this.cloneValue(J.oldValue,I,W);J.undo?J.undo():"add"===E?y.remove(I,{keepChildren:!0}):"remove"===E?y.contains(I)||y.add(I,c.rootsIndex,c.datasIndex):"clear"===E?y.deserialize(O.clone(J.json)):"property"===E?"parent"===W?H?H.addChild(I,c.oldIndex):(I.setParent(H),0<=c.oldIndex&&y.moveTo(I,c.oldIndex)):(D=null,0===W.indexOf("a:")?(D="attr",W=W.replace("a:","")):0===W.indexOf("s:")?(D="style",W=W.replace("s:","")):0===W.indexOf("f:")&&(D="field",W=W.replace("f:","")),n.setPropertyValue(I,D,W,H)):"dataModelProperty"===E?(D=null,0===W.indexOf("a:")?(D="attr",W=W.replace("a:","")):0===W.indexOf("s:")?(D="style",W=W.replace("s:","")):0===W.indexOf("f:")&&(D="field",W=W.replace("f:","")),n.setPropertyValue(y,D,W,H)):"hierarchy"===E?y.moveTo(I,J.oldIndex):"index"===E?y.moveToIndex(I,J.oldIndex):"selection"===E&&y.sm().ss(J.oldValue)}},afterUndo:function(R){},redo:function(R){this.setHistoryIndex(this._historyIndex+(R=!R||R<=0?1:R))},$2p:function(R){if(this.canRedo()){var y,Z=this,D=Z._histories,J=Z._historyIndex,E=0;for(Z._isUndoRedoing=!0,O.setIsolating(!0);0<R;)-1<=J&&J<D.length-1&&(E++,y=D[++J],Z.redoImpl(y)),R--;O.setIsolating(!1),delete Z._isUndoRedoing,this.afterRedo(E)}},redoImpl:function(R){for(var y=this._dataModel,Z=0;Z<R.length;Z++){var D,J=R[Z],E=J.kind,I=J.data,W=J.property,c=J.event,H=this.cloneValue(J.newValue,I,W);J.redo?J.redo():"add"===E?(J.parent&&!I.getParent()&&J.parent.addChild(I,J.siblingsIndex),y.contains(I)||y.add(I,c.rootsIndex,c.datasIndex),this.restoreChildren(J.childrenInfo),I instanceof a.Node&&(I.setHost(J.host),J.attaches&&J.attaches.forEach(function(R){R.setHost(I)})),I instanceof a.Edge&&(I.setSource(J.source),I.setTarget(J.target))):"remove"===E?y.remove(I):"clear"===E?y.clear():"property"===E?"parent"===W?H?H.addChild(I,c.newIndex):(I.setParent(H),0<=c.newIndex&&y.moveTo(I,c.newIndex)):(D=null,0===W.indexOf("a:")?(D="attr",W=W.replace("a:","")):0===W.indexOf("s:")?(D="style",W=W.replace("s:","")):0===W.indexOf("f:")&&(D="field",W=W.replace("f:","")),n.setPropertyValue(I,D,W,H)):"dataModelProperty"===E?(D=null,0===W.indexOf("a:")?(D="attr",W=W.replace("a:","")):0===W.indexOf("s:")?(D="style",W=W.replace("s:","")):0===W.indexOf("f:")&&(D="field",W=W.replace("f:","")),n.setPropertyValue(y,D,W,H)):"hierarchy"===E?y.moveTo(I,J.newIndex):"index"===E?y.moveToIndex(I,J.newIndex):"selection"===E&&y.sm().ss(J.newValue)}},afterRedo:function(R){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);