var Fluid=function(){"use strict";function _(e,t,n){t=e.createShader(t);if(e.shaderSource(t,n),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(t));return t}function a(e,t,n){var i=e.createProgram(),t=_(e,e.VERTEX_SHADER,t),n=_(e,e.FRAGMENT_SHADER,n);if(e.attachShader(i,t),e.attachShader(i,n),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(i));for(var a={program:i},r=e.getProgramParameter(i,e.ACTIVE_ATTRIBUTES),o=0;o<r;o++){var l=e.getActiveAttrib(i,o);a[l.name]=e.getAttribLocation(i,l.name)}for(var s=e.getProgramParameter(i,e.ACTIVE_UNIFORMS),u=0;u<s;u++){var c=e.getActiveUniform(i,u);a[c.name]=e.getUniformLocation(i,c.name)}return a}function c(e,t,n,i,a){var r=e.createTexture();return e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t),n instanceof Uint8Array?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,a,0,e.RGBA,e.UNSIGNED_BYTE,n):n instanceof Float32Array?e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,i,a,0,e.RGBA,e.FLOAT,n):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_2D,null),r}function r(e,t,n){e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_2D,t)}function l(e,t){var n=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),n}function o(e,t,n,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(n),e.vertexAttribPointer(n,i,e.FLOAT,!1,0,0)}function n(e,t,n){e.bindFramebuffer(e.FRAMEBUFFER,t),n&&e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0)}var s="precision highp float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\nuniform float u_point_size;\n\nvarying vec2 v_particle_pos;\n\n\nconst vec2 bitEnc = vec2(1.,255.);\nconst vec2 bitDec = 1./bitEnc;\n\nvec2 fromRGBA(const vec4 color) {\n  vec4 rounded_color = floor(color * 255.0 + 0.5) / 255.0;\n  float x = dot(rounded_color.rg, bitDec);\n  float y = dot(rounded_color.ba, bitDec);\n  return vec2(x, y);\n}\n\nvoid main() {\n  vec2 uv = vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res);\n    vec4 color = texture2D(u_particles, uv);\n\n    \t\t    vec2 pos = fromRGBA(color);\n    v_particle_pos =  pos;\n\n    gl_PointSize = u_point_size;\n    gl_Position = vec4(2.0 * pos.x - 1.0, 1.0 - 2.0 * pos.y, 0, 1);\n}",u="precision highp float;\n\nuniform sampler2D u_field;\nuniform vec2 u_speed_min;\nuniform vec2 u_speed_max;\nuniform sampler2D u_color_ramp;\nuniform float u_point_alpha;\nvarying vec2 v_particle_pos;\n\nuniform float u_fixedColor;\nuniform vec4 u_color;\n\nuniform float u_alphaBlendSpeed;\nuniform float u_speedThreshold;\n\nvoid main() {\n\n    float alpha = u_point_alpha;\n\n    vec2 velocity = mix(u_speed_min, u_speed_max, texture2D(u_field, v_particle_pos).rg);\n    float speed_t = length(velocity) / length(u_speed_max);\n\n    alpha = alpha * step(u_speedThreshold, speed_t) * (1.0 - u_alphaBlendSpeed + u_alphaBlendSpeed * speed_t);\n\n     vec2 ramp_pos = vec2(\n        0.5,\n        1.0 - speed_t);\n\n    gl_FragColor = texture2D(u_color_ramp, ramp_pos);\n    gl_FragColor = u_color * u_fixedColor + (1.0 - u_fixedColor) * gl_FragColor;\n\n    gl_FragColor.a = alpha ;\n}",A="precision highp float;\n\nuniform sampler2D u_field;\nuniform vec2 u_speed_min;\nuniform vec2 u_speed_max;\nuniform sampler2D u_color_ramp;\nuniform float u_point_alpha;\nvarying vec2 v_particle_pos;\n\nuniform float u_fixedColor;\nuniform vec4 u_color;\n\nuniform vec2 u_space;\nuniform vec2 u_spaceRect0;\nuniform vec2 u_spaceRect1;\nuniform int u_isSpaceReverse;\nuniform float u_alphaBlendSpeed;\nuniform float u_speedThreshold;\n\n\nvoid main() {\n\n    float alpha = u_point_alpha;\n\n    vec2 p0 = vec2(v_particle_pos) - 0.5;\n    float l = length(p0);\n    if(l < u_space.x) {\n        alpha = 0.0;\n    }\n    if(l > u_space.y) {\n        alpha = 0.0;\n    }\n\n    if(abs(p0.x) < u_spaceRect0.x && abs(p0.y) < u_spaceRect0.y) {\n        alpha = 0.0;\n    }\n    if(abs(p0.x) > u_spaceRect1.x || abs(p0.y) > u_spaceRect1.y) {\n        alpha = 0.0;\n    }\n\n    if(u_isSpaceReverse == 1) {\n        alpha = 1.0 - alpha;\n    }\n\n    vec2 velocity = mix(u_speed_min, u_speed_max, texture2D(u_field, v_particle_pos).rg);\n    float speed_t = length(velocity) / length(u_speed_max);\n\n    alpha = alpha * step(u_speedThreshold, speed_t) * (1.0 - u_alphaBlendSpeed + u_alphaBlendSpeed * speed_t);\n\n     vec2 ramp_pos = vec2(\n        0.5,\n        1.0 - speed_t);\n\n    gl_FragColor = texture2D(u_color_ramp, ramp_pos);\n    gl_FragColor = u_color * u_fixedColor + (1.0 - u_fixedColor) * gl_FragColor;\n    gl_FragColor.a = alpha ;\n}",d="precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}",p="precision highp float;\n\nuniform sampler2D u_screen;\nuniform float u_opacity;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_screen, 1.0 - v_tex_pos);\n        gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n}\n",h="precision highp float;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_field;\nuniform vec2 u_field_res;\nuniform vec2 u_speed_min;\nuniform vec2 u_speed_max;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\n\nvarying vec2 v_tex_pos;\n\nconst vec2 bitEnc = vec2(1.,255.);\nconst vec2 bitDec = 1./bitEnc;\n\nvec2 fromRGBA(const vec4 color) {\n  vec4 rounded_color = floor(color * 255.0 + 0.5) / 255.0;\n  float x = dot(rounded_color.rg, bitDec);\n  float y = dot(rounded_color.ba, bitDec);\n  return vec2(x, y);\n}\n\nvec4 toRGBA (const vec2 pos) {\n  vec2 rg = bitEnc * pos.x;\n  rg = fract(rg);\n  rg -= rg.yy * vec2(1. / 255., 0.);\n\n  vec2 ba = bitEnc * pos.y;\n  ba = fract(ba);\n  ba -= ba.yy * vec2(1. / 255., 0.);\n\n  return vec4(rg, ba);\n}\n\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\n\nvoid main() {\n    vec4 color = texture2D(u_particles, v_tex_pos);\n\n        vec2 pos = fromRGBA(color);\n\n    vec2 velocity = mix(u_speed_min, u_speed_max, texture2D(u_field, pos).rg);\n    float speed_t = length(velocity) / length(u_speed_max);\n\n    vec2 offset = vec2(velocity.x, -velocity.y) * 0.0001 * u_speed_factor;\n\n        pos = fract(1.0 + pos + offset);\n\n        vec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\n        float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n    float drop = step(1.0 - drop_rate, rand(seed));\n\n    vec2 random_pos = vec2(\n        rand(seed + 1.3),\n        rand(seed + 2.1));\n    pos = mix(pos, random_pos, drop);\n\n        \n    gl_FragColor = toRGBA(pos);\n\n}",f="precision highp float;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_field;\nuniform sampler2D u_wall;\nuniform int u_wall_count;\n\nuniform vec2 u_field_res;\nuniform vec2 u_speed_min;\nuniform vec2 u_speed_max;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\n\nvarying vec2 v_tex_pos;\n\nconst vec2 bitEnc = vec2(1.,255.);\nconst vec2 bitDec = 1./bitEnc;\n\nvec2 fromRGBA(const vec4 color) {\n  vec4 rounded_color = floor(color * 255.0 + 0.5) / 255.0;\n  float x = dot(rounded_color.rg, bitDec);\n  float y = dot(rounded_color.ba, bitDec);\n  return vec2(x, y);\n}\n\nvec4 toRGBA (const vec2 pos) {\n  vec2 rg = bitEnc * pos.x;\n  rg = fract(rg);\n  rg -= rg.yy * vec2(1. / 255., 0.);\n\n  vec2 ba = bitEnc * pos.y;\n  ba = fract(ba);\n  ba -= ba.yy * vec2(1. / 255., 0.);\n\n  return vec4(rg, ba);\n}\n\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvec2 lookup_field(const vec2 uv) {\n        vec2 px = 1.0 / u_field_res;\n            vec2 vc = (floor(uv * u_field_res)) * px; \n    vec2 f = fract(uv * u_field_res);\n    vec2 tl = texture2D(u_field, vc).rg;\n    vec2 tr = texture2D(u_field, vc + vec2(px.x, 0)).rg;\n    vec2 bl = texture2D(u_field, vc + vec2(0, px.y)).rg;\n    vec2 br = texture2D(u_field, vc + px).rg;\n    return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n}\n\nvec2 getPos(vec2 old, vec2 newP) {\n    const int MAX_ITERATIONS = 100; \n    vec2 start, end, uv;\n    float px = 1.0 / float(u_wall_count);\n    for(int i = 0; i < MAX_ITERATIONS; i++) {\n      if(i >= u_wall_count) {\n        break;\n      }\n      uv = vec2(0.0,  px * (float(i) + 0.5));\n      start = fromRGBA(texture2D(u_wall, uv));\n      uv = vec2(0.5,  px * (float(i) + 0.5));\n      end = fromRGBA(texture2D(u_wall, uv));\n\n      vec2 t0 = old - end;\n      vec2 t1 = newP - end;\n      vec2 t2 = start - end;\n      vec3 r0 = cross(vec3(t0, 0.0), vec3(t2, 0.0));\n      vec3 r1 = cross(vec3(t1, 0.0), vec3(t2, 0.0));\n      if(r0.z * r1.z >= 0.0) {\n        continue;\n      }\n\n      vec2 t4 = old - start;\n\n      float a0 = dot(t2, t0);\n      float a1 = dot(-t2, t4);\n      if(a1 < 0.0 || a0 < 0.0) {\n        continue;\n      }\n      vec2 t5 = newP - old;\n\n      vec2 n0 = normalize(t2);\n      vec2 n = vec2(n0.y, -n0.x);\n\n      vec2 ret = reflect(t5, n);\n      return ret + newP;\n    }\n    return newP;\n}\n\n\n\n\n\nvoid main() {\n    vec4 color = texture2D(u_particles, v_tex_pos);\n\n        vec2 oldPos = fromRGBA(color);\n\n    vec2 velocity = mix(u_speed_min, u_speed_max, lookup_field(oldPos));\n    float speed_t = length(velocity) / length(u_speed_max);\n\n    vec2 offset = vec2(velocity.x, -velocity.y) * 0.0001 * u_speed_factor;\n\n        vec2 pos = fract(1.0 + oldPos + offset);\n\n        vec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\n        float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n    float drop = step(1.0 - drop_rate, rand(seed));\n\n    vec2 random_pos = vec2(\n        rand(seed + 1.3),\n        rand(seed + 2.1));\n    pos = mix(pos, random_pos, drop);\n\n    if(u_wall_count > 0) {\n      pos = getPos(oldPos, pos);\n    }\n\n        \n    gl_FragColor = toRGBA(pos);\n\n}",g="data:image/png;base64,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",v="precision highp float;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_field;\nuniform vec2 u_field_res;\n\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\n\nuniform vec2 u_speed_min;\nuniform vec2 u_speed_max;\n\nuniform vec2 u_dir;\n\nvarying vec2 v_tex_pos;\n\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvoid main() {\n    vec2 pos = texture2D(u_particles, v_tex_pos).rg;\n    vec2 velocityT = texture2D(u_field, pos).rg;     vec2 velocity;\n    velocity.x = u_dir.x * velocityT.x - u_dir.y * velocityT.y;\n    velocity.y = u_dir.y * velocityT.x + u_dir.x * velocityT.y; \n\n    float speed_t = length(velocity) / length(u_speed_max);\n\n    vec2 offset = vec2(velocity.x, -velocity.y) * 0.0001 * u_speed_factor;\n\n        pos = fract(1.0 + pos + offset);\n\n        vec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\n        float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n    float drop = step(1.0 - drop_rate, rand(seed));\n\n    vec2 random_pos = vec2(\n        rand(seed + 1.3),\n        rand(seed + 2.1));\n    pos = mix(pos, random_pos, drop);\n\n    gl_FragColor = vec4(pos, 1.0, 1.0);\n\n}",m="precision highp float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_field;\nuniform float u_particles_res;\nuniform float u_point_size;\n\nvarying vec2 v_particle_pos;\nvarying vec2 v_angle;\nvarying vec2 v_velocity;\n\nuniform vec2 u_dir;\n\nvoid main() {\n  vec2 uv = vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res);\n    vec2 pos = texture2D(u_particles, uv).rg;\n\n    v_particle_pos =  pos;\n\n    vec2 velocityT = texture2D(u_field, v_particle_pos).rg;\n    v_velocity.x = u_dir.x * velocityT.x - u_dir.y * velocityT.y;\n    v_velocity.y = u_dir.y * velocityT.x + u_dir.x * velocityT.y; \n\n#ifdef SUPPORT_ARROW\n    v_angle = normalize(v_velocity);\n#endif\n\n\n    gl_PointSize = u_point_size;\n    gl_Position = vec4(2.0 * pos.x - 1.0, 1.0 - 2.0 * pos.y, 0, 1);\n}",C="precision highp float;\n\nuniform sampler2D u_field;\nuniform float u_speed_min_length;\nuniform float u_speed_max_length;\nuniform sampler2D u_color_ramp;\nuniform float u_point_alpha;\nvarying vec2 v_particle_pos;\n\nuniform float u_fixedColor;\nuniform vec4 u_color;\n\nuniform float u_alphaBlendSpeed;\nuniform float u_speedThreshold;\n\nuniform sampler2D u_shape; \nuniform float u_alphaTest;\nuniform float u_heightScale;\n\nuniform float u_useShapeColor;\nuniform float u_useClipPicColor;\n\nvarying vec2 v_velocity;\n\n#ifdef SUPPORT_ARROW\nvarying vec2 v_angle;\n#endif\n\n#ifdef ENABLE_CLIP\nuniform sampler2D u_clipPic;\n#endif\n\nvoid main() {\n#ifdef ENABLE_CLIP\n    vec4 clipColor = texture2D(u_clipPic, vec2(v_particle_pos.x, 1.0 - v_particle_pos.y));\n    if(clipColor.a == 0.0) {\n        discard;\n    }\n#endif\n\n    float alpha = u_point_alpha;\n    float shapeFlag = 1.0;\n\n#ifdef SUPPORT_ARROW\n    vec2 newCoord;\n    newCoord.x = ((gl_PointCoord.x - 0.5) * v_angle.x - (gl_PointCoord.y - 0.5) * v_angle.y) + 0.5;\n    newCoord.y = ((gl_PointCoord.x - 0.5) * v_angle.y + (gl_PointCoord.y - 0.5) * v_angle.x) * u_heightScale + 0.5;\n\n    vec4 shape = texture2D(u_shape, newCoord);\n#else\n    vec4 shape = texture2D(u_shape, gl_PointCoord);\n#endif\n\n    shapeFlag = step(u_alphaTest, shape.a);\n\n    float speed_t = (length(v_velocity) - u_speed_min_length) / length(u_speed_max_length - u_speed_min_length);\n\n    alpha = alpha * step(u_speedThreshold, speed_t) * (1.0 - u_alphaBlendSpeed + u_alphaBlendSpeed * speed_t) * shapeFlag;\n\n     vec2 ramp_pos = vec2(\n        0.5,\n        1.0 - speed_t);\n\n    gl_FragColor = texture2D(u_color_ramp, ramp_pos);\n    gl_FragColor = u_color * u_fixedColor + (1.0 - u_fixedColor) * gl_FragColor;\n    gl_FragColor = u_useShapeColor * shape + (1.0 - u_useShapeColor) * gl_FragColor;\n#ifdef ENABLE_CLIP\n    gl_FragColor = u_useClipPicColor * clipColor + (1.0 - u_useClipPicColor) * gl_FragColor;\n#endif\n    gl_FragColor.a = alpha ;\n}",E=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var w=void 0,T=void 0,w="",T="";function B(e,t){E(this,B),this._g3d=e,this._gl=e.getGL(),this._config=t;var n=this._gl;this._config.textureFloat&&(n.getExtension("OES_texture_float"),n.getExtension("OES_texture_float_linear"),n.getExtension("EXT_color_buffer_float"));var i=1024,e=1024;this._pointSize=1,this._alpha=1,this._supportWall=!1,this._wallNumber=0,this._wallTexture=null,this._space=[0,1],this._spaceRect0=[0,0],this._spaceRect1=[1,1],this._speedThreshold=0,this._isBlendSpeed=0,this._blendDstAlpha=!0,this._enableClipPicColor=0,this._enableShapeColor=0,this.setFieldRotateDir(0),this.setClipPicture(null),t&&(this._pointSize=t.pointSize||1,i=t.width||1024,e=t.height||1024,t.supportWall&&(this._supportWall=!0)),this._createRenderBuffer(i,e),this._resolution=[i,e],this._color=[1,0,0,1],this._fixedColor=0,this._alphaTest=.05,this.setArrowHeightScale(1),this._fadeSpeed=.996,this._speedFactor=.25,this._dropRate=.003,this._dropRateBump=.01,this._bgProgram=a(n,d,p),this._supportWall?(this._updateProgram=a(n,d,f),this._drawProgramNormal=a(n,w+s,T+A)):this._config.textureFloat?(this._updateProgram=a(n,d,v),this._drawProgramNormal=a(n,w+m,T+C),this._drawProgramArrow=a(n,w+"#define SUPPORT_ARROW\r\n"+m,T+"#define SUPPORT_ARROW\r\n"+C)):(this._updateProgram=a(n,d,h),this._drawProgramNormal=a(n,w+s,T+u)),this._drawProgram=this._drawProgramNormal,this._vertexBuffer=l(n,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1])),this._framebuffer=n.createFramebuffer(),this._resize(),this.setSpeedColor(),this.setShapeTexture(g)}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}(B,[{key:"enableArrow",value:function(e){(this._arrowEnabled=e)?(this._drawProgram=this._drawProgramArrow,this.setShapeTexture("data:image/png;base64,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")):(this._drawProgram=this._drawProgramNormal,this.setShapeTexture(g))}},{key:"setArrowHeightScale",value:function(e){this._arrowHeighScale=e}},{key:"setResolution",value:function(e,t){e?this._resolution=[e,t]:(e=this._resolution[0],t=this._resolution[1]),this._createRenderBuffer(e,t),this._resize()}},{key:"getResolution",value:function(){return this._resolution.slice(0)}},{key:"_createRenderBuffer",value:function(e,t){t=new ht.graph3d.RenderTarget(this._g3d,this._gl,e,t,{autoSize:!1});this._renderTarget=t}},{key:"_createWallTexture",value:function(e){var t=this._gl,i=new Uint8Array(2*e.length*4);this._wallNumber=e.length;var a=0;e.forEach(function(e){var t,n;e.forEach(function(e){t=Math.floor(65535*e[0]),n=Math.floor(65535*e[1]),i[a]=Math.floor(t/256),i[++a]=t%256,i[++a]=Math.floor(n/256),i[++a]=n%256,a++})}),this._wallTexture=c(t,t.NEAREST,i,2,this._wallNumber)}},{key:"_resize",value:function(){var e=this._gl,t=new Uint8Array(this._renderTarget.width*this._renderTarget.height*4);this._bgTexture=c(e,e.NEAREST,t,this._renderTarget.width,this._renderTarget.height),this._screenTexture=c(e,e.NEAREST,t,this._renderTarget.width,this._renderTarget.height)}},{key:"setWalls",value:function(e){this._createWallTexture(e)}},{key:"setSpeedColor",value:function(e){var t=this;e=(this._speedColorUrl=e)||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAEACAYAAAByPhyYAAAABGdBTUEAALGeYUxB9wAAACBjSFJNAACHEAAAjBIAAP1NAACBPgAAWesAARIPAAA85gAAGc66ySIyAAABI2lDQ1BJQ0MgcHJvZmlsZQAAKM9jYGAycHRxcmUSYGDIzSspCnJ3UoiIjFJgP8/AxsDMAAaJycUFjgEBPiB2Xn5eKgMqYGRg+HYNRDIwXNYFmcVAGuBKLigqAdJ/gNgoJbU4GWikAZCdXV5SABRnnANkiyRlg9kbQOyikCBnIPsIkM2XDmFfAbGTIOwnIHYR0BNA9heQ+nQwm4kDbA6ELQNil6RWgOxlcM4vqCzKTM8oUTC0tLRUcEzJT0pVCK4sLknNLVbwzEvOLyrIL0osSU0BqoW4DwwEIQpBIaYB1GihyUBlAIoHCOtzIDh8GcXOIMQQILm0qAwWF0zGhPkIM+ZIMDD4L2VgYPmDEDPpZWBYoMPAwD8VIaZmyMAgoM/AsG8OAMKzT/7p48VkAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABXBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NTc3MiwgMjAxNC8wMS8xMy0xOTo0NDowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxNCAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE0LTA4LTE4VDEwOjUwOjM4LTA3OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE0LTA4LTE4VDEwOjUxOjIzLTA3OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxNC0wOC0xOFQxMDo1MToyMy0wNzowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NDQ3OTdCQjAyNzAwMTFFNDkzQ0FGNDQ5N0YwRDA1RUUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDQ3OTdCQjEyNzAwMTFFNDkzQ0FGNDQ5N0YwRDA1RUUiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo3NzRjZjFiMC1kYzFiLTQzNGEtOTBlZS1iMWFhYTI1YzcyZGYiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjc3NGNmMWIwLWRjMWItNDM0YS05MGVlLWIxYWFhMjVjNzJkZiIgc3RFdnQ6d2hlbj0iMjAxNC0wOC0xOFQxMDo1MDozOC0wNzowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTQgKFdpbmRvd3MpIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3NzRjZjFiMC1kYzFiLTQzNGEtOTBlZS1iMWFhYTI1YzcyZGYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6Nzc0Y2YxYjAtZGMxYi00MzRhLTkwZWUtYjFhYWEyNWM3MmRmIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+NEy64QAAARVJREFUOE9tlAlywzAMAxnnaPv/x/aOCm5cQcHYM9kBSJq6IteoGlvpWXFunKa6PKvbVNcDqxZ7zFngzo4F3P6o7qVB+9cG7YnFQPEu60BRF/DEURRj6QIYsnHv7L3X8dtAgZ8JEgD7faC+pqIOS5ZW788xVCAS7hIl4LNBiV/zNBjSMb8Wc/aKbPVbQaxRp6G/1NBW/m/cuXGZFhUx7HXGnCBmkLhNS4mtVVirt4ZHcyJi0crw7B3zskDEvFTAvqC88sbohDZwhc5nK235anUqewwVoM5Wx78mdNQ7wgKKUX2WWUL2KEZ7xz6eLVlPPKzXQWfg9erjpGeMTRevHtCNrK0n+FC6tKsKq4u8F9ui9DloVfUHj7J4OpTd4bQAAAAASUVORK5CYII=";var n=new Image;n.src=e,n.addEventListener("load",function(){t.colorRampTexture=c(t._gl,t._gl.LINEAR,n)})}},{key:"setParticleNum",value:function(e){var t=this._gl,e=this._particleStateResolution=Math.ceil(Math.sqrt(e));this._numParticles=e*e;var n=void 0;if(this._config.textureFloat)for(var n=new Float32Array(4*this._numParticles),i=0;i<n.length;i++)n[i]=256*Math.random();else{n=new Uint8Array(4*this._numParticles);for(var a=0;a<n.length;a++)n[a]=Math.floor(256*Math.random())}this._particleStateTexture0=c(t,t.NEAREST,n,e,e),this._particleStateTexture1=c(t,t.NEAREST,n,e,e);for(var r=new Float32Array(this._numParticles),o=0;o<this._numParticles;o++)r[o]=o;this._particleIndexBuffer=l(t,r)}},{key:"getParticleNum",value:function(){return this._numParticles}},{key:"setShapeTexture",value:function(e){var t=this,n=new Image;n.src=e,n.addEventListener("load",function(){t._shapeTexture=c(t._gl,t._gl.LINEAR,n)})}},{key:"setFieldData",value:function(e,t){if((this._fieldData=e).image)this._loadDataFromImage(e,t);else if(e.dataFile)this._loadDataFromFile(e,t);else{if(e.data){var n=e.data,i=1,a=!0;void 0!==e.data3d&&(a=e.data3d),e.dataScale&&(i=e.dataScale);var r=void 0;if(a){var o=3,l=[0,2];e.groupLength&&(o=e.groupLength),e.groupPos&&(l=e.groupPos);for(var r=new Float32Array(n.length/o*4),s=0;s<n.length/o;s++)r.set([n[s*o+l[0]]*i,n[s*o+l[1]]*i,0,1],4*s)}else{r=new Float32Array(n.length/2*4);for(var u=0;u<n.length/2;u++)r.set([n[2*u]*i,n[2*u+1]*i,0,1],4*u)}this._fieldTexture=c(this._gl,this._gl.LINEAR,r,e.width,e.height)}void 0===this._fieldData.minLength&&(this._fieldData.minLength=0,this._fieldData.maxLength=20),t&&t(e)}}},{key:"_loadDataFromImage",value:function(l,s){var u=this,e=l.image;ImageToData(e,null,null,0,0,function(e){for(var t=l.max[0]-l.min[0],n=(l.max[1],l.min[1],l.max[2]-l.min[2]),i=new Float32Array(e.width*e.height*4),a=0;a<e.data.length;a+=4){var r=e.data[a]/255*t+l.min[0],o=e.data[a+2]/255*n+l.min[2];i.set([r,0,o,1],a)}l.tall=1,l.data=i,l.width=e.width,l.height=e.height,u._fieldTexture=c(u._gl,u._gl.LINEAR,l.data,l.width,l.height*l.tall),u._updateMaterial({"material.u_field":u._fieldTexture}),void 0===u._fieldData.minLength&&(u._fieldData.minLength=0,u._fieldData.maxLength=20),s&&s(l)})}},{key:"_loadDataFromFile",value:function(l,s){var u=this;ht.Default.xhrLoad(l.dataFile,function(e){var t=1,n=!0;void 0!==l.data3d&&(n=l.data3d),l.dataScale&&(t=l.dataScale);var i=JSON.parse(e),a=[];if(n)for(var r=0;r<i.length;r+=3)a.push(i[r]*t,i[r+1]*t,i[r+2]*t,1);else for(var o=0;o<i.length;o++)a.push(i[o]*t);e=new Float32Array(a.length);e.set(a),l.tall=n?a.length/(l.width*l.height*4):a.length/(l.width*l.height),l.data=e,u._fieldTexture=c(u._gl,u._gl.LINEAR,l.data,l.width,l.height*l.tall),void 0===u._fieldData.minLength&&(u._fieldData.minLength=0,u._fieldData.maxLength=20),s&&s(l)})}},{key:"setSpeedRange",value:function(e,t){this._fieldData.minLength=e,this._fieldData.maxLength=t}},{key:"_draw",value:function(){var e=this._gl;e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),r(e,this._fieldTexture,0),r(e,this._particleStateTexture0,1),r(e,this._shapeTexture,3),this._drawScreen(),this._updateParticles()}},{key:"_drawScreen",value:function(){var e=this._gl;n(e,this._framebuffer,this._screenTexture),e.viewport(0,0,this._renderTarget.width,this._renderTarget.height),this._clearTrailing?this._drawTexture(this._bgTexture,0):this._drawTexture(this._bgTexture,this._fadeSpeed),this._drawParticles(),n(e,null),this._renderTarget.bind(e),e.enable(e.BLEND),this._clearTrailing?(this._clearTrailing=!1,e.blendFunc(e.SRC_ALPHA,e.GL_ZERO)):(t=this._blendDstAlpha?e.ONE_MINUS_DST_ALPHA:e.ONE_MINUS_SRC_ALPHA,e.blendFunc(e.SRC_ALPHA,t)),this._drawTexture(this._screenTexture,1),e.disable(e.BLEND);var t=this._bgTexture;this._bgTexture=this._screenTexture,this._screenTexture=t,this._renderTarget.unbind(e)}},{key:"_drawTexture",value:function(e,t){var n=this._gl,i=this._bgProgram;n.useProgram(i.program),o(n,this._vertexBuffer,i.a_pos,2),r(n,e,2),n.uniform1i(i.u_screen,2),n.uniform1f(i.u_opacity,t),n.drawArrays(n.TRIANGLES,0,6)}},{key:"_drawParticles",value:function(){var e=this._gl,t=this._drawProgram;e.useProgram(t.program),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),o(e,this._particleIndexBuffer,t.a_index,1),r(e,this.colorRampTexture,2),this._clipTexture&&r(e,this._clipTexture,4),e.uniform1i(t.u_field,0),e.uniform1i(t.u_particles,1),e.uniform1i(t.u_color_ramp,2),e.uniform1i(t.u_shape,3),e.uniform1i(t.u_clipPic,4),e.uniform1f(t.u_particles_res,this._particleStateResolution),e.uniform1f(t.u_point_size,this._pointSize),e.uniform1f(t.u_point_alpha,this._alpha),e.uniform1f(t.u_fixedColor,this._fixedColor),e.uniform1f(t.u_alphaTest,this._alphaTest),e.uniform1f(t.u_heightScale,this._arrowHeighScale),e.uniform4f(t.u_color,this._color[0],this._color[1],this._color[2],this._color[3]),e.uniform1f(t.u_speed_min_length,this._fieldData.minLength),e.uniform1f(t.u_speed_max_length,this._fieldData.maxLength),e.uniform1f(t.u_useShapeColor,this._enableShapeColor),e.uniform1f(t.u_useClipPicColor,this._enableClipPicColor),e.uniform1i(t.u_isSpaceReverse,this._isReverseSpace?1:0),e.uniform2f(t.u_space,this._space[0],this._space[1]),e.uniform2f(t.u_spaceRect0,this._spaceRect0[0],this._spaceRect0[1]),e.uniform2f(t.u_spaceRect1,this._spaceRect1[0],this._spaceRect1[1]),e.uniform2f(t.u_dir,this._fieldRotateDir[0],this._fieldRotateDir[1]),e.uniform1f(t.u_speedThreshold,this._speedThreshold),e.uniform1f(t.u_alphaBlendSpeed,this._isBlendSpeed),e.drawArrays(e.POINTS,0,this._numParticles)}},{key:"_updateParticles",value:function(){var e=this._gl;n(e,this._framebuffer,this._particleStateTexture1),e.viewport(0,0,this._particleStateResolution,this._particleStateResolution);var t=this._updateProgram;e.useProgram(t.program),o(e,this._vertexBuffer,t.a_pos,2),e.uniform1i(t.u_field,0),e.uniform1i(t.u_particles,1),e.uniform1f(t.u_rand_seed,Math.random()),e.uniform2f(t.u_dir,this._fieldRotateDir[0],this._fieldRotateDir[1]),this._supportWall&&(r(e,this._wallTexture,2),e.uniform1i(t.u_wall_count,this._wallNumber),e.uniform1i(t.u_wall,2)),e.uniform2f(t.u_field_res,this._fieldData.width,this._fieldData.height),e.uniform2f(t.u_speed_min,this._fieldData.xMin,this._fieldData.yMin),e.uniform2f(t.u_speed_max,this._fieldData.xMax,this._fieldData.yMax),e.uniform1f(t.u_speed_factor,this._speedFactor),e.uniform1f(t.u_drop_rate,this._dropRate),e.uniform1f(t.u_drop_rate_bump,this._dropRateBump),e.drawArrays(e.TRIANGLES,0,6);t=this._particleStateTexture0;this._particleStateTexture0=this._particleStateTexture1,this._particleStateTexture1=t,n(e,null)}},{key:"startSimulation",value:function(){var e=this;if(!this._fieldData)return this.stopSimulation(),!(this._toStartSim=!0);this.stopSimulation();function t(){e._draw(),e._g3d.redraw(),e._animationId=requestAnimationFrame(t)}return this._animationId=requestAnimationFrame(t),!0}},{key:"stopSimulation",value:function(){this._toStartSim=!1,cancelAnimationFrame(this._animationId)}},{key:"getImage",value:function(){return this._renderTarget.uuid}},{key:"setParticleSize",value:function(e){this._pointSize=e}},{key:"setFadeSpeed",value:function(e){this._fadeSpeed=.95+(.999-.95)*e,this._originalFadeSpeed=e}},{key:"getFadeSpeed",value:function(){return this._fadeSpeed}},{key:"setDropRate",value:function(e){this._dropRate=e}},{key:"getDropRate",value:function(){return this._dropRate}},{key:"setSpeedFactor",value:function(e){this._speedFactor=.05+.95*e,this._originalSpeedFactor=e}},{key:"getSpeedFactor",value:function(e){return this._speedFactor}},{key:"setDropRateBump",value:function(e){this._dropRateBump=e}},{key:"getDropRateBump",value:function(e){return this._dropRateBump}},{key:"setAlpha",value:function(e){this._alpha=e}},{key:"getAlpha",value:function(){return this._alpha}},{key:"setColor",value:function(e){e?(e=ht.Default.toColorData(e),this._color=[e[0]/255,e[1]/255,e[2]/255,e[3]/255],this._fixedColor=1):this._fixedColor=0}},{key:"getVersion",value:function(){return"1.13"}},{key:"setSpace",value:function(e,t){this._space=[e,t],this._clearTrailing=!0}},{key:"setSpaceR0",value:function(e){this._space[0]=e,this._clearTrailing=!0}},{key:"setSpaceR1",value:function(e){this._space[1]=e,this._clearTrailing=!0}},{key:"reverseSpaceSelection",value:function(e){this._isReverseSpace=e,this._clearTrailing=!0}},{key:"setSpaceRect",value:function(e,t){this._spaceRect0=e,this._spaceRect1=t,this._clearTrailing=!0}},{key:"setSpaceRect0",value:function(e){this._spaceRect0=e,this._clearTrailing=!0}},{key:"setSpaceRect1",value:function(e){this._spaceRect1=e,this._clearTrailing=!0}},{key:"clearTrailing",value:function(){this._clearTrailing=!0}},{key:"setSpaceRect0X",value:function(e){this._spaceRect0[0]=e,this._clearTrailing=!0}},{key:"setSpaceRect0Y",value:function(e){this._spaceRect0[1]=e,this._clearTrailing=!0}},{key:"setSpaceRect1X",value:function(e){this._spaceRect1[0]=e,this._clearTrailing=!0}},{key:"setSpaceRect1Y",value:function(e){this._spaceRect1[1]=e,this._clearTrailing=!0}},{key:"setSpeedThreshold",value:function(e){this._speedThreshold=e,this._clearTrailing=!0}},{key:"setBlendSpeed",value:function(e){this._isBlendSpeed=e?1:0,this._clearTrailing=!0}},{key:"setBlendDstAlpha",value:function(e){this._blendDstAlpha=e}},{key:"loadConfig",value:function(e,t){var n=void 0;for(n in e)null!=e[n]&&this._execConfig(n,e,t)}},{key:"_execConfig",value:function(e,t,n){var i,a,r=this,o=t[e];switch(e){case"blendDstAlpha":this.setBlendDstAlpha(o);break;case"blendSpeed":this.setBlendSpeed(o);break;case"speedThreshold":this.setSpeedThreshold(o);break;case"particleColor":this.setColor(o);break;case"alpha":this.setAlpha(o);break;case"dropRate":this.setDropRate(o);break;case"dropRateBump":this.setDropRateBump(o);break;case"speedFactor":this.setSpeedFactor(o);break;case"fadeSpeed":this.setFadeSpeed(o);break;case"fieldData":o.imageUrl?((i=new Image).src=o.imageUrl,((a={width:o.width,height:o.height,xMin:o.xMin,xMax:o.xMax,yMin:o.yMin,yMax:o.yMax,zMin:o.zMin,zMax:o.zMax,imageUrl:o.imageUrl}).image=i).onload=function(){r.setFieldData(a),n&&n(r._fieldData)}):this.setFieldData(o);break;case"particleSize":this.setParticleSize(o);break;case"particleNum":this.setParticleNum(o);break;case"speedColor":this.setSpeedColor(o);break;case"resolution":this.setResolution(o[0],o[1])}}},{key:"setFieldRotateDir",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,e=e*Math.PI/180;this._fieldRotateDir=[t*Math.cos(e),t*Math.sin(e)],this._rotateStrength=t}},{key:"setFieldRotateAngle",value:function(e){this.setFieldRotateDir(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1)}},{key:"getConfig",value:function(){var e=this._fieldData,e={width:e.width,height:e.height,xMin:e.xMin,xMax:e.xMax,yMin:e.yMin,yMax:e.yMax,zMin:e.zMin,zMax:e.zMax,data:e.data};return{blendDstAlpha:this._blendDstAlpha,blendSpeed:this._isBlendSpeed,speedThreshold:this._speedThreshold,particleColor:1==this._fixedColor?this._color:null,alpha:this._alpha,dropRate:this._dropRate,dropRateBump:this._dropRateBump,speedFactor:this._originalSpeedFactor,fadeSpeed:this._originalFadeSpeed,fieldData:e,particleSize:this._pointSize,particleNum:this._numParticles,speedColor:this._speedColorUrl,resolution:this._resolution,fieldRotateDir:this._fieldRotateDir,fieldRotateStrength:this._rotateStrength}}},{key:"setAlphaTest",value:function(e){this._alphaTest=e}},{key:"setClipPicture",value:function(e){var t=this;this._clipPic=e||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAQSURBVBhXY/iPAwwpif//Aboev0GEdLc5AAAAAElFTkSuQmCC";var n=new Image;n.src=this._clipPic,n.addEventListener("load",function(){t._clipTexture=c(t._gl,t._gl.LINEAR,n)})}},{key:"enableShapeColor",value:function(e){this._enableShapeColor=e?1:0}},{key:"enableClipPicColor",value:function(e){this._enableClipPicColor=e?1:0}},{key:"isShapeColorEnabled",value:function(){return 1==this._enableShapeColor}},{key:"isClipPicColorEnabled",value:function(){return 1==this._enableClipPicColor}}],[{key:"registerShader",value:function(e){(e=e||{}).enableClip&&(T="#define ENABLE_CLIP\r\n")}}]),B}();
