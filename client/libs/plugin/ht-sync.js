var SyncTerminal=function(){"use strict";window.log_level=4;function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var t=function(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),t};function s(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}var r=(t(e,[{key:"init",value:function(t,e,i,s,n,o,r,a){this.ws_ip=e,this.ws_port=i,this.wss_port=i,this.onOpen=n,this.onError=o,this.onClose=r,this.onMessage=a,this.scope=s,this._closed=!1,this._reconnectTimeout="",t||(t="ws://"+this.ws_ip+":"+this.ws_port,"https:"==window.location.protocol&&(t="wss://"+this.ws_ip+":"+this.wss_port)),this.url=t,this.setupSocket()}},{key:"_clearReconnectTimeout",value:function(){""!=this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout="")}},{key:"_setReconnectTimeout",value:function(t){var e=this;t=t||5e3,this._reconnectTimeout=setTimeout(function(){e.setupSocket()},t)}},{key:"setupSocket",value:function(){var e=this;if(!this._closed){var t,i,s=void 0,n=void 0,o=void 0,r=void 0;if(t=this.url,i=this.scope,s=this.onOpen,o=this.onClose,n=this.onError,r=this.onMessage,!this.isActive()){try{this.socket=new WebSocket(t)}catch(t){return this._clearReconnectTimeout(),void this._setReconnectTimeout()}s&&n&&o&&r&&(this.socket.onopen=function(t){e.socket.onclose=function(t){o(i,t),e._clearReconnectTimeout(),e._setReconnectTimeout()},e.socket.onmessage=function(t){r(i,t)},s(i,t)},this.socket.onerror=function(t){n(i,t),e._clearReconnectTimeout(),e._setReconnectTimeout()})}}}},{key:"close",value:function(){this.socket.close(),this._clearReconnectTimeout(),this._closed=!0}},{key:"open",value:function(){this._closed=!1,this.reInit()}},{key:"isActive",value:function(){return!(!this.socket||1!=this.socket.readyState)}},{key:"send",value:function(t){return!!this.isActive()&&(this.socket.send(t),!0)}},{key:"reInit",value:function(){this.isActive()&&this.socket.close(),this._clearReconnectTimeout(),this.setupSocket()}}]),e);function e(){o(this,e)}var a="3c60c781ed";function c(t,e,i,s){var n=this;o(this,c),this._g3d=t,this._g2d=e,this._url=null,s||(this._url=i),this._server=i||"localhost",this._port=s||7010,this._role=this._getRole(),this._groupId=this._getGroup(),this._cb={},this._syncCamera=!1,this._syncView=!1,this._ws=new r,this._cameraCb=function(t){var e=t.property;if("eye"==e||"center"==e){var i={type:"SYNC",data:{msg:a+"CAMERA",parameter:[n._g3d.getEye(),n._g3d.getCenter()]}};n._ws.send(JSON.stringify(i))}},this._viewCb=function(t){var e=t.property,i=!1,s={type:"SYNC",data:{msg:a+"VIEW2D",parameter:{property:e,value:t.newValue}}};"translateX"==e&&(i=!0),"translateY"==e&&(i=!0),"zoom"==e&&(i=!0),i&&n._ws.send(JSON.stringify(s))},this._miCb=function(t){"clickData"==t.kind&&n._myFire("CLICK_DATA",{x:t.event.clientX||t.event.touches[0].clientX,y:t.event.clientY||t.event.touches[0].clientY})},this._onCamera=function(t){n._g3d.setEye(t[0]),n._g3d.setCenter(t[1])},this._onView2d=function(t){"translateX"!=t.property?"translateY"!=t.property?"zoom"!=t.property||n._g2d.setZoom(t.value):n._g2d.setTranslateY(t.value):n._g2d.setTranslateX(t.value)},this._onReload=function(t){window.location.reload(t.isFromServer)},this._onAlert=function(t){alert(t.message)},this._onClear=function(t){n._g3d.dm().clear()},this._onClickData=function(t){var e=n._g3d.getDataAt(t);n._clickDataCb(e)},this._myAdd("RELOAD",this._onReload),this._myAdd("ALERT",this._onAlert),this._myAdd("CLEAR",this._onClear)}return t(c,[{key:"setGraphView3d",value:function(t){this._syncCamera&&this._g3d.ump(this._cameraCb),this._g3d=t,this._syncCamera&&this.isMaster()&&this._g3d.mp(this._cameraCb)}},{key:"setGraphView2d",value:function(t){this._syncView&&this._g2d.ump(this._viewCb),this._g2d=t,this._syncView&&this.isMaster()&&this._g2d.mp(this._viewCb)}},{key:"setSyncCamera",value:function(t){this._syncCamera!=t&&((this._syncCamera=t)?(this.isMaster()&&this._g3d.mp(this._cameraCb),this._cb[a+"CAMERA"]=this._onCamera):this._g3d.ump(this._cameraCb))}},{key:"setSyncView",value:function(t){this._syncView!=t&&((this._syncView=t)?(this.isMaster()&&this._g2d.mp(this._viewCb),this._cb[a+"VIEW2D"]=this._onView2d):this._g2d.ump(this._onView2d))}},{key:"add",value:function(t,e){this._cb[t]=e}},{key:"_myAdd",value:function(t,e){this.add(a+t,e)}},{key:"isSyncCamera",value:function(){return this._syncCamera}},{key:"isMaster",value:function(){return"master"==this._role}},{key:"_myFire",value:function(t,e){this.fire(a+t,e)}},{key:"fire",value:function(t,e){if(this.isMaster()){var i={type:"SYNC",data:{msg:t,parameter:e}};this._ws.send(JSON.stringify(i))}}},{key:"_initWebsocket",value:function(){var i=this;this._ws.init(this._url,this._server,this._port,this,function(t,e){i._onOpen(t,e)},function(t,e){i._onError(t,e)},function(t,e){i._onClose(t,e)},function(t,e){i._onMessage(t,e)})}},{key:"_register",value:function(){var t={type:"REGISTER",origin:window.origin+this._groupId,role:"slave"};this.isMaster()&&(t.role="master"),this._ws.send(JSON.stringify(t))}},{key:"_onOpen",value:function(){console.log("ws is ready"),this._register()}},{key:"_onClose",value:function(){}},{key:"_onError",value:function(){}},{key:"_onMessage",value:function(t,e){var i=JSON.parse(e.data);if(this.isMaster()){if(i.isRetrieve)return void(this._getSlaveCb&&this._getSlaveCb(i.data));this._role="slave",this._syncCamera&&this._g3d.ump(this._cameraCb),this._syncView&&this._g2d.ump(this._viewCb)}this._cb[i.msg]&&this._cb[i.msg](i.parameter)}},{key:"_getRole",value:function(){return this._getInput("syncRole")}},{key:"_getGroup",value:function(){return this._getInput("syncGroup")}},{key:"_getInput",value:function(t){var e=location.href;return new URL(e).searchParams.get(t)}},{key:"fireReload",value:function(t){this._myFire("RELOAD",{isFromServer:t})}},{key:"fireAlert",value:function(t){this._myFire("ALERT",{message:t})}},{key:"fireClear",value:function(){this._myFire("CLEAR",{})}},{key:"getSlaves",value:function(t){t&&(this._getSlaveCb=t,this.isMaster()&&this._ws.send(JSON.stringify({type:"RETRIEVE"})))}},{key:"setClickData",value:function(){}},{key:"stop",value:function(){this._ws&&this._ws.isActive()&&this._ws.close()}},{key:"start",value:function(){this._monitorView(),this._ws.isActive()?this._ws.open():this._initWebsocket()}},{key:"_monitorView",value:function(){this._g3d&&(this._g3d.ump(this._cameraCb),this._syncCamera&&this.isMaster()&&this._g3d.mp(this._cameraCb)),this._g2d&&(this._g2d.ump(this._viewCb),this._syncView&&this.isMaster()&&this._g2d.mp(this._onView2d))}},{key:"setMaster",value:function(t){this._role=t?"master":"slave",this._monitorView(),this._ws&&this._ws.isActive()&&this._register()}},{key:"setSlave",value:function(t){this.setMaster(!t)}},{key:"setGroupId",value:function(t){this._groupId=t}},{key:"getGroupId",value:function(){return this._groupId}},{key:"getServerInfo",value:function(){return[this._url,this._server,this._port]}},{key:"setUrl",value:function(t){this._url=t}}]),c}();
