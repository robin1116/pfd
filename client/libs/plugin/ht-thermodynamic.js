!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t.ht=t.ht||{},t.ht.thermodynamic={}))}(this,function(t){"use strict";var n=((0,eval)("this")||(0,eval)("global")||(0,eval)("window")).ht;var u=n.Math.Vector3,x=n.Default,v=x.callLater,w="t_horizontal",c="t_xVertical",f="t_yVertical",j="thermodynamic.image",s={min:10,max:100,radius:50,box:new u(20,20,20),step:.1,colorStopFn:function(t,i){return t*i*i*i},remainMax:!1,gradient:{0:"rgba(0,162,255,0.14)",.2:"rgba(48,255,183,0.30)",.4:"rgba(255,245,48,0.50)",.6:"rgba(255,73,18,0.90)",.8:"rgba(217,22,0,0.95)",1:"rgb(179,0,0)"},opacity:.1,interval:10,blur:1,thickness:10,offset:.1};n.Default.setImage(j,{width:12,height:12,comps:[{type:"rect",background:"rgb(51,153,255)",borderColor:"#979797",rect:[0,0,12,12]}]});function i(t,i){this.g3d=t,this.config=Object.assign(x.clone(s),i),this.t={},this.i=[],this.h=[],this.n={},this.a={},this.temperatureList=[],this.pavarte=this.getColorPavarte(this.config.gradient)}i.prototype.setData=function(t){this.temperatureList=t},i.prototype.getDatas=function(){return this.temperatureList},i.prototype.configure=function(t){var i=this.config.gradient;this.config=Object.assign(this.config,t),this.r(i,this.config.gradient)||(this.pavarte=this.getColorPavarte(i))},i.prototype.setThermodynamicBox=function(t,i,s){this.config.box=new u(t,i,s)},i.prototype.getPointInfo=function(t){var i=this.config;return x.isObject(t)?{value:t.value,radius:t.radius||i.radius}:{value:t,radius:i.radius}},i.prototype.createThermodynamicNode=function(t,i,s){var h=this.config.box;this.e=t,this.o=i,this.u=s,this.c=x.getId(),this.loadThermodynamicMoel(t,i,s);s=this.f=new n.Node;return s.s3(h.x,h.z,h.y),s.s({shape3d:this.getThermodynamicModelName(),"wf.visible":!0,"shape3d.transparent":!0}),s},i.prototype.loadThermodynamicMoel=function(t,i,s){this.n={},this.a={},this.destoryModels(),this.destoryImage(),this.v(t,i,s)},i.prototype.getThermodynamicModelName=function(){return this.c||(this.c=x.getId()),"_thermodynamicBox"+this.c},i.prototype.renderAll=function(){var r=this,i=this.g3d,t=this.config,e=t.remainMax,o=t.gradient,u=this.n||{},c=this.a||{};Object.keys(u).forEach(function(t){var i=u[t],s=c[t],h=t.split("_"),n=h[0],a=h[1],t=r.d(n,r.config.box,{},r.p(n)),h=i.canvas;h.width=t.x,h.height=t.y,r.renderPoints(a,n,e,i);n=s.canvas;n.width=t.x,n.height=t.y,r.renderCanvas(o,e,i,s)}),Object.keys(this.t).forEach(function(t){i.deleteTexture(t)}),i.invalidateData(this.f)},i.prototype.renderCanvas=function(t,i,s,h){for(var n=t?this.getColorPavarte(t):this.pavarte,t=s.canvas,t=s.getImageData(0,0,t.width,t.height),a=t.data,r=a.length,e=i?0:3,o=0;o<r;o+=4){var u=4*a[o+e];a[o]=n[u],a[o+1]=n[1+u],a[o+2]=n[2+u],a[o+3]=n[3+u]}h.putImageData(t,0,0)},i.prototype.renderPoints=function(t,i,s,h){for(var n=this.getDatas(),a=new u,r=0,e=n.length;r<e;++r){var o=n[r];this.d(i,o.position,a,this.p(i)),a.z=a.z-t;o=o.temperature;s?this.l(h,a,o,i):this.b(h,a,o,i)}},i.prototype.getHeatMap=function(t,i,s,h){var n=this.config.remainMax;t=Math.max(0,t);var a,r=this.d(i,this.config.box,{},this.p(i)),e=[i,Math.min(r.z,t),n].join("_"),o=this.n[e];return o||((a=document.createElement("canvas")).width=r.x,a.height=r.y,this.n[e]=o=a.getContext("2d",{alpha:!0}),o.clearRect(0,0,a.width,a.height),this.renderPoints(t,i,n,o)),h?((a=h.canvas).width=r.x,a.height=r.y):((a=document.createElement("canvas")).width=r.x,a.height=r.y,h=a.getContext("2d",{alpha:!0})),this.a[e]=h,this.renderCanvas(s,n,o,h),h.canvas},i.prototype.getColorPavarte=function(t){var i=document.createElement("canvas"),s=i.getContext("2d");i.width=256,i.height=1;var h,n=s.createLinearGradient(0,0,256,1);for(h in t)n.addColorStop(h,t[h]);return s.fillStyle=n,s.fillRect(0,0,256,1),s.getImageData(0,0,256,1).data},i.prototype.getCanvasMap=function(){return this.t},i.prototype.getHeatMapValue=function(t,i){var s=this.config,h=this.f;s.remainMax;if(h){var n=h.getTall(),a=h.getScaleTall(),r=(h.getRect(),h.getAnchor3d()),a=n*a,a=(h.getX(),h.getElevation(),r.y,h.getY(),Math.floor(this.u/2)),e=.5;"bottom"===i?e=a=0:"top"===i&&(a=this.u-1,e=1);a=this.t[this.h[a]];if(!a)return 0;h=this.g3d.intersectObject(t,h);if(!h)return 0;h=h.local,h={x:(h.x+.5)*a.width,y:(h.z+.5)*a.height};h.x=parseInt(h.x),h.y=parseInt(h.y);for(var o=a.getContext("2d").getImageData(h.x,h.y,1,1).data,a=s.max,h=s.min,u=0,c=this.pavarte,f=c.length,v=0;v<f;v++)if(o[0]===c[e=4*v]&&o[1]===c[e+1]&&o[2]===c[e+2]&&o[3]===c[e+3]){u=v;break}h=Math.abs(a-h)*(u/255)+h;return(h+=h*s.offset)?h.toFixed(1):0}},i.prototype.startAnim=function(t,i){this.startAnim(t,i)},i.prototype.startScan=function(t,i){var s=this.g3d;s&&(s.dm(),t=t,console.log(t))},i.prototype.stopScan=function(){},i.prototype.destory=function(){this.destoryModels(),this.destoryImage(),this.f.removeFromDataModel(),this.m=!0},i.prototype.destoryImage=function(){var i=x.getImageMap(),s=this.g3d;Object.keys(this.t).forEach(function(t){delete i[t],s.deleteTexture(t)}),this.t={},this.h=[]},i.prototype.destoryModels=function(){x.getShape3dModelMap&&(this.i.forEach(function(t){x.setShape3dModel(t,void 0)}),this.i=[])},i.prototype.g=function(t){var i=this.config,s=i.step,h=i.colorStopFn,n=i.min,a=i.max,t=this.getPointInfo(t),r=t.value;return{radius:t.radius,step:s,getValue:function(t){var i=Math.max(0,Math.min(1,(r-n)/(a-n)));return h(i,t)}}},i.prototype.r=function(i,s){var h=!0;return i===s||Object.keys(i).forEach(function(t){h&&(s[t]&&i[t]===s[t]||(h=!1))}),h},i.prototype.d=function(t,i,s,h){switch(t){case"x":s.x=i.x*h,s.y=i.z*h,s.z=i.y;break;case"y":s.x=i.y*h,s.y=i.z*h,s.z=i.x;break;case"z":s.x=i.x*h,s.y=i.y*h,s.z=i.z}return s},i.prototype.p=function(t){var i=this.config.box,s=this.config.gradient,h=Object.keys(s).length,n=this.config.blur,s=void 0;return n=n<h/(s="x"===t?Math.min(i.x,i.z):"y"===t?Math.min(i.y,i.z):Math.min(i.x,i.y))?h/s:n},i.prototype.b=function(t,i,s,h){var n=this.g(s),s=n.radius*n.radius-i.z*i.z;if(!(s<=0)){for(var h=this.p(h),h=Math.sqrt(s)*h,a=t.createRadialGradient(i.x,i.y,h,i.x,i.y,0),r=n.getValue((n.radius-Math.abs(i.z))/n.radius),e=n.step,o=0;o<=1;o+=e)a.addColorStop(o,"rgba(0, 0, 0, "+n.getValue(o*r)+")");t.save(),t.fillStyle=a,t.beginPath(),t.arc(i.x,i.y,h,0,2*Math.PI,!1),t.fill(),t.restore()}},i.prototype.l=function(t,i,s,h){var n=this.g(s),s=n.radius*n.radius-i.z*i.z;if(!(s<=0)){for(var h=this.p(h),h=Math.sqrt(s)*h,a=t.createRadialGradient(i.x,i.y,h,i.x,i.y,0),r=n.getValue((n.radius-Math.abs(i.z))/n.radius),e=n.step,o=0;o<=1;o+=e){var u=n.getValue(o*r),c=255*u;a.addColorStop(o,"rgba("+c+", "+c+", "+c+", "+u+")")}t.save(),t.globalCompositeOperation="lighten",t.fillStyle=a,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()}},i.prototype._=function(s,h,n,a,r,e,o,t){var u=this,c=this.g3d,f=u.config;v(function(){var t,i;u.m||(i=(t=u.t[h])&&t.getContext("2d"),x.setShape3dModel(s,{vs:r,is:e,uv:o,image:h,color:"rgb(90,171,224)",reverseFlip:!0,transparent:f.opacity<1,opacity:f.opacity}),t=u.getHeatMap(n,a,null,i),x.setImage(h,t),u.t[h]=t,u.i.push(s),c&&c.invalidateData(u.f),u.number++,u.number===u.size&&c.firePropertyChange("thermodynamicLoaded",!1,!0))},this,null,t)},i.prototype.M=function(t){for(var i=this,s=i.config,h=s.box,n=1===t?0:1/(t-1),a=[],r=0;r<t;r++){var e=r*n,o=x.getId(),u=[w,"_model_",o].join(""),o=[w,"_image_",o].join("");i._(u,o,n*r*h.z,"z",[-.5,e-.5,-.5,.5,e-.5,-.5,.5,e-.5,.5,-.5,e-.5,.5],[2,1,0,0,3,2],[0,0,1,0,1,1,0,1],s.interval*r),i.h.push(o),a.push({shape3d:u}),x.setShape3dModel(w+i.c,a),i.i.push(w+i.c)}},i.prototype.w=function(t){for(var i=this.config,s=i.box,h=1===t?0:1/(t-1),n=[],a=0;a<t;a++){var r=a*h,e=x.getId(),o=[c,"_model_",e].join(""),e=[c,"_image_",e].join("");this._(o,e,h*a*s.y,"x",[-.5,-.5,r-.5,.5,-.5,r-.5,.5,.5,r-.5,-.5,.5,r-.5],[2,1,0,2,3,0],[0,0,1,0,1,1,0,1],i.interval*a),n.push({shape3d:o}),x.setShape3dModel(c+this.c,n),this.i.push(c+this.c)}},i.prototype.j=function(t){for(var i=this.config,s=i.box,h=1===t?0:1/(t-1),n=[],a=0;a<t;a++){var r=a*h,e=x.getId(),o=[f,"_model_",e].join(""),e=[f,"_image_",e].join("");this._(o,e,h*a*s.x,"y",[r-.5,-.5,.5,r-.5,-.5,-.5,r-.5,.5,-.5,r-.5,.5,.5],[2,1,0,2,3,0],[1,0,0,0,0,1,1,1],i.interval*a),n.push({shape3d:o}),x.setShape3dModel(f+this.c,n),this.i.push(f+this.c)}},i.prototype.v=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;this.m=!1;var h=this;h.size=t+i+s,h.number=0,v(function(){s&&h.M(s),t&&h.w(t),i&&h.j(i)}),h.i.push(this.getThermodynamicModelName()),x.setShape3dModel(this.getThermodynamicModelName(),[{shape3d:w+this.c},{shape3d:c+this.c},{shape3d:f+this.c}])},i.prototype.createThermodynamicByShape=function(t,i){this.config.box=new u(i.getWidth(),i.getHeight(),i.getTall()),this.c=x.getId(),this.loadThermodynamicMoelByShape(t,i);t=this.f=new n.Node;return t.s3(i.getWidth(),i.getTall(),i.getHeight()),t.s({shape3d:this.getThermodynamicModelName(),"shape3d.transparent":!0}),t},i.prototype.loadThermodynamicMoelByShape=function(t,i){var s=this;this.n={},this.a={},this.destoryModels(),this.destoryImage(),this.m=!1,this.size=t,this.number=0,v(function(){s.O(t,i)}),this.i.push(this.getThermodynamicModelName()),x.setShape3dModel(this.getThermodynamicModelName(),[{shape3d:w+this.c}])},i.prototype.O=function(t,i){var s=this,h=s.config,n=h.box,a=[],r=1===t?0:1/(t-1),e=[],o=s.g3d.getData3dUI(i);if(o){var u=i.s("shape3d.top.image");u||i.s("shape3d.top.image",j),o.validate();o=x.clone(o.shapeModel);if(i.s("shape3d.top.image",u),o){for(var c=o.top_vs,f=o.top_uv,i=i.getRect(),v=i.width,d=i.height,p=i.x,l=i.y,b=0;b<c.length;b+=3)a.push((c[b]-p)/v-.5),a.push(-.5),a.push((c[b+2]-l)/d-.5);for(var m=0;m<t;m++){for(var g=m*r,_=x.getId(),M=[w,"_model_",_].join(""),_=[w,"_image_",_].join(""),y=0;y<a.length;y+=3)a[y+1]=g-.5;s._(M,_,g*n.z,"z",x.clone(a),void 0,f,h.interval*m),s.h.push(_),e.push({shape3d:M}),x.setShape3dModel(w+s.c,e),s.i.push(w+s.c)}}}},t.Thermodynamic3d=i,Object.defineProperty(t,"__esModule",{value:!0})});
